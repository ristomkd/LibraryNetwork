@model LibraryNetwork.Models.Member

@{
    ViewData["Title"] = Model.FullName;
    var hasImage = !string.IsNullOrEmpty(Model.ImageUrl);
    var activeLoans = Model.Loans?.Where(l => l.ReturnDate == null).ToList() ?? new List<LibraryNetwork.Models.Loan>();
}

<h1 class="page-header"><i class="bi bi-person me-2"></i>Member Profile</h1>

<div class="row g-4">
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body py-4">
                @if (hasImage)
                {
                    <img src="@Model.ImageUrl" alt="@Model.FullName"
                         class="rounded-circle mb-3"
                         style="width: 120px; height: 120px; object-fit: cover; border: 4px solid var(--lib-peach);" />
                }
                else
                {
                    <div class="d-inline-flex align-items-center justify-content-center rounded-circle mb-3"
                         style="width: 120px; height: 120px; background: var(--lib-peach); color: var(--lib-primary); font-weight: 800; font-size: 2.5rem;">
                        @(Model.FirstName?.Substring(0, 1))@(Model.LastName?.Substring(0, 1))
                    </div>
                }
                <h4 style="font-family: var(--lib-font-heading); color: var(--lib-primary); font-weight: 700;">@Model.FullName</h4>
                <span class="badge" style="background: rgba(92,61,46,.08); color: var(--lib-primary); border: 1px solid rgba(92,61,46,.15);">
                    <i class="bi bi-person-badge me-1"></i>Member
                </span>
            </div>
        </div>
    </div>
    <div class="col-md-8">
        <div class="card">
            <div class="card-header"><i class="bi bi-info-circle me-1"></i> Member Information</div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-4">Email</dt>
                    <dd class="col-sm-8"><i class="bi bi-envelope me-1" style="color: var(--lib-accent);"></i>@Model.Email</dd>
                    <dt class="col-sm-4">Membership #</dt>
                    <dd class="col-sm-8"><code>@Model.MembershipNumber</code></dd>
                    <dt class="col-sm-4">Phone</dt>
                    <dd class="col-sm-8"><i class="bi bi-telephone me-1" style="color: var(--lib-accent);"></i>@(Model.phoneNumber ?? "—")</dd>
                    <dt class="col-sm-4">Active Loans</dt>
                    <dd class="col-sm-8"><span class="badge badge-active">@activeLoans.Count</span></dd>
                    <dt class="col-sm-4">Total Loans</dt>
                    <dd class="col-sm-8">@(Model.Loans?.Count ?? 0)</dd>
                </dl>
            </div>
            <div class="card-footer d-flex gap-2">
                <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-sm btn-warning"><i class="bi bi-pencil me-1"></i>Edit</a>
                <a asp-action="Index" class="btn btn-sm btn-lib-outline"><i class="bi bi-arrow-left me-1"></i>Back to List</a>
            </div>
        </div>
    </div>
</div>

@if (Model.Loans != null && Model.Loans.Any())
{
    <h4 class="page-header mt-5"><i class="bi bi-clock-history me-2"></i>Loan History</h4>
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-lib mb-0">
                    <thead>
                        <tr><th>Book</th><th>Borrowed</th><th>Due</th><th>Returned</th><th>Status</th></tr>
                    </thead>
                    <tbody>
                        @foreach (var loan in Model.Loans.OrderByDescending(l => l.BorrowDate))
                        {
                            <tr>
                                <td class="fw-semibold" style="color: var(--lib-primary);">@(loan.BookCopy?.Book?.Title ?? "—")</td>
                                <td>@loan.BorrowDate?.ToString("MMM dd, yyyy")</td>
                                <td>@loan.DueDate?.ToString("MMM dd, yyyy")</td>
                                <td>@(loan.ReturnDate?.ToString("MMM dd, yyyy") ?? "—")</td>
                                <td>
                                    @if (loan.IsOverdue) { <span class="badge badge-overdue">Overdue</span> }
                                    else if (loan.ReturnDate != null) { <span class="badge badge-returned">Returned</span> }
                                    else { <span class="badge badge-active">Active</span> }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}
