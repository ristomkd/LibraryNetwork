@model IEnumerable<LibraryNetwork.Models.Book>
@using Microsoft.AspNetCore.Mvc.Rendering

@{
    ViewData["Title"] = "Books";
}

<h1 class="page-header"><i class="bi bi-journal-bookmark me-2"></i>Books</h1>

<!-- Filter bar -->
<form asp-action="Index" method="get" class="filter-bar">
    <div class="row g-2 align-items-end">
        <div class="col-md-3">
            <label class="form-label fw-semibold small text-muted">Title</label>
            <input type="text" name="searchTitle" class="form-control"
                   placeholder="Search title…"
                   value="@Context.Request.Query["searchTitle"]" />
        </div>
        <div class="col-md-2">
            <label class="form-label fw-semibold small text-muted">Author</label>
            <input type="text" name="searchAuthor" class="form-control"
                   placeholder="Search author…"
                   value="@Context.Request.Query["searchAuthor"]" />
        </div>
        <div class="col-md-2">
            <label class="form-label fw-semibold small text-muted">Category</label>
            <select name="category" class="form-select"
                    asp-items="@(ViewData["Categories"] as SelectList)">
                <option value="">All</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label fw-semibold small text-muted">Library</label>
            <select name="libraryId" class="form-select"
                    asp-items="@(ViewData["Libraries"] as SelectList)">
                <option value="">All</option>
            </select>
        </div>
        <div class="col-md-3 d-flex gap-2">
            <button type="submit" class="btn btn-lib-primary">
                <i class="bi bi-funnel me-1"></i>Filter
            </button>
            <a asp-action="Index" class="btn btn-lib-outline">Clear</a>
            @if (User.IsInRole("Admin"))
            {
                <a asp-action="Create" class="btn btn-lib-accent">
                    <i class="bi bi-plus-circle me-1"></i>Add
                </a>
            }
        </div>
    </div>
</form>

<!-- Book grid -->
<div class="row g-4">
    @foreach (var b in Model)
    {
        var total = b.BookCopies?.Count ?? 0;
        var available = b.BookCopies?.Count(c => c.IsAvailable) ?? 0;

        <div class="col-12 col-sm-6 col-md-4 col-lg-3">
            <div class="card book-card h-100">
                <img class="card-img-top"
                     src="@(string.IsNullOrEmpty(b.ImageUrl) ? "/images/books/default.png" : b.ImageUrl)"
                     alt="@b.Title"
                     style="height:220px; object-fit:cover;" />

                <div class="card-body">
                    <h5 class="card-title">@b.Title</h5>
                    <p class="card-text mb-1"><i class="bi bi-pen me-1"></i>@b.Author</p>
                    <p class="card-text mb-1"><i class="bi bi-tag me-1"></i>@b.Category</p>
                    <p class="card-text mb-0 mt-2">
                        <small>
                            <strong>@total</strong> copies &bull;
                            <span class="@(available > 0 ? "text-success" : "text-danger") fw-bold">
                                @available available
                            </span>
                        </small>
                    </p>
                </div>

                <div class="card-footer d-flex gap-2 flex-wrap">
                    <a asp-action="Details" asp-route-id="@b.Id" class="btn btn-sm btn-lib-primary">
                        <i class="bi bi-eye me-1"></i>Details
                    </a>

                    @if (User.IsInRole("Member") && available > 0)
                    {
                        <a asp-controller="Loans" asp-action="Borrow" asp-route-id="@b.Id"
                           class="btn btn-sm btn-lib-accent">
                            <i class="bi bi-bookmark-plus me-1"></i>Borrow
                        </a>
                    }

                    @if (User.IsInRole("Admin"))
                    {
                        <a asp-action="Edit" asp-route-id="@b.Id" class="btn btn-sm btn-warning">
                            <i class="bi bi-pencil"></i>
                        </a>
                        <a asp-action="Delete" asp-route-id="@b.Id" class="btn btn-sm btn-danger">
                            <i class="bi bi-trash"></i>
                        </a>
                    }
                </div>
            </div>
        </div>
    }
</div>

@if (!Model.Any())
{
    <div class="text-center py-5 text-muted">
        <i class="bi bi-journal-x" style="font-size: 3rem;"></i>
        <p class="mt-2">No books found matching your criteria.</p>
    </div>
}
